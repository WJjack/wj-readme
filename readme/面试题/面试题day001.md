## 11æœŸé¢è¯•é¢˜day001

### React setState è°ƒç”¨ä¹‹åå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿæ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Ÿ

#### ä¸€ã€æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹setStateçš„å¦‚ä¸‹ä¸¤ç§å†™æ³•

* ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¯¹è±¡çš„å†™æ³•ï¼š

  ```js
  this.setState({
    key: newState,
  });
  ```

* ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å‡½æ•°çš„å†™æ³•ï¼š

  ```js
  // prevState æ˜¯ä¸Šä¸€æ¬¡çš„ stateï¼Œprops æ˜¯æ­¤æ¬¡æ›´æ–°è¢«åº”ç”¨æ—¶çš„ props
  this.setState((prevState, props) => {
    return {
      key: prevState.key,
    };
  });
  ```

é‚£ä¹ˆï¼Œè¿™ä¸¤ç§å†™æ³•çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹è®¡æ•°å™¨çš„ä¾‹å­ï¼š

```jsx
class App extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      val: 0,
    };
  }
  handleClick() {
    this.setState({
      val: this.state.val + 1,
    });
  }
  render() {
    return (
      <div className="App">
        <input type="text" value={this.state.val} disabled />
        <input type="button" onClick={this.handleClick.bind(this)} />
      </div>
    );
  }
}
```

å¦‚æœåœ¨ handleClick æ–¹æ³•å†…è°ƒä¸¤æ¬¡ setStateï¼Œæ˜¯ä¸æ˜¯æ¯æ¬¡ç‚¹å‡»å°±è‡ªå¢ 2 äº†å‘¢ï¼Ÿ

```js
handleClick () {
    this.setState({
        val: this.state.val + 1
    })
     this.setState({
        val: this.state.val + 1
    })
  }
```

ç»“æœå¹¶éæˆ‘ä»¬æƒ³çš„é‚£æ ·ï¼Œæ¯æ¬¡ç‚¹å‡»æŒ‰é’®ï¼Œä¾ç„¶æ˜¯è‡ªå¢ 1ã€‚è¿™æ˜¯å› ä¸ºè°ƒç”¨ setState å…¶å®æ˜¯å¼‚æ­¥çš„ï¼Œä¹Ÿå°±æ˜¯ setState è°ƒç”¨ä¹‹åï¼Œthis.state ä¸ä¼šç«‹å³æ˜ å°„ä¸ºæ–°çš„å€¼ã€‚ä¸Šé¢ä»£ç ä¼šè§£æä¸ºä»¥ä¸‹å½¢å¼ï¼š

```js
/ åé¢çš„æ•°æ®ä¼šè¦†ç›–å‰é¢çš„æ›´æ”¹ï¼Œæ‰€ä»¥æœ€ç»ˆåªåŠ äº†ä¸€æ¬¡.
Object.assign(previousState, { val: state.val + 1 }, { val: state.val + 1 });
```

åœ¨ä¸Šé¢æˆ‘ä»¬è°ƒç”¨äº†ä¸¤æ¬¡ setStateï¼Œä½† state çš„æ›´æ–°ä¼šè¢«åˆå¹¶ï¼Œæ‰€ä»¥å³ä½¿å¤šæ¬¡è°ƒç”¨ setStateï¼Œå®é™…ä¸Šå¯èƒ½ä¹Ÿåªæ˜¯ä¼šé‡æ–°æ¸²æŸ“ä¸€æ¬¡ã€‚

å¦‚æœæƒ³åŸºäºå½“å‰çš„ state æ¥è®¡ç®—å‡ºæ–°çš„å€¼ï¼Œé‚£ä¹ˆ setState ç¬¬ä¸€ä¸ªå‚æ•°ä¸åº”è¯¥åƒä¸Šé¢ä¸€æ ·ä¼ é€’ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œåº”è¯¥ä¼ é€’ä¸€ä¸ªå‡½æ•°ã€‚

```js
handleClick () {
        this.setState(function (state, props) {
      return { val: state.val + 1 };
    });
    this.setState(function (state, props) {
      return { val: state.val + 1 };
    });
 }
```

æ­¤æ—¶ï¼Œåœ¨ handleClick æ–¹æ³•å†…è°ƒä¸¤æ¬¡ setStateï¼Œå°±èƒ½å®ç°æ¯æ¬¡ç‚¹å‡»éƒ½è‡ªå¢ 2 äº†ã€‚

ä¼ é€’ä¸€ä¸ªå‡½æ•°å¯ä»¥è®©ä½ åœ¨å‡½æ•°å†…è®¿é—®åˆ°å½“å‰çš„ state å€¼ã€‚ setState çš„è°ƒç”¨æ˜¯åˆ†æ‰¹çš„ï¼Œæ‰€ä»¥å¯ä»¥é“¾å¼åœ°è¿›è¡Œæ›´æ–°ï¼Œå¹¶ç¡®ä¿å®ƒä»¬æ˜¯ä¸€ä¸ªå»ºç«‹åœ¨å¦ä¸€ä¸ªä¹‹ä¸Šçš„ï¼Œè¿™æ ·æ‰ä¸ä¼šå‘ç”Ÿå†²çªã€‚

setState çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯é€‰çš„å›è°ƒå‡½æ•°ã€‚è¿™ä¸ªå›è°ƒå‡½æ•°å°†åœ¨ç»„ä»¶é‡æ–°æ¸²æŸ“åæ‰§è¡Œã€‚ç­‰ä»·äºåœ¨ componentDidUpdate ç”Ÿå‘½å‘¨æœŸå†…æ‰§è¡Œã€‚é€šå¸¸å»ºè®®ä½¿ç”¨ componentDidUpdate æ¥ä»£æ›¿æ­¤æ–¹å¼ã€‚åœ¨è¿™ä¸ªå›è°ƒå‡½æ•°ä¸­ä½ å¯ä»¥æ‹¿åˆ°æ›´æ–°å state çš„å€¼ã€‚

```js
this.setState({
    key1: newState1,
    key2: newState2,
    ...
}, callback) // ç¬¬äºŒä¸ªå‚æ•°æ˜¯ state æ›´æ–°å®Œæˆåçš„å›è°ƒå‡½æ•°
```

é€šè¿‡ä¸Šé¢å†…å®¹ï¼Œå¯ä»¥çŸ¥é“è°ƒç”¨ setState æ—¶ï¼Œç»„ä»¶çš„ state å¹¶ä¸ä¼šç«‹å³æ”¹å˜ï¼Œ setState åªæ˜¯æŠŠè¦ä¿®æ”¹çš„ state æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ï¼Œ React ä¼šä¼˜åŒ–çœŸæ­£çš„æ‰§è¡Œæ—¶æœºï¼Œå¹¶å‡ºäºæ€§èƒ½åŸå› ï¼Œä¼šå°† React äº‹ä»¶å¤„ç†ç¨‹åºä¸­çš„å¤šæ¬¡ React äº‹ä»¶å¤„ç†ç¨‹åºä¸­çš„å¤šæ¬¡ setState çš„çŠ¶æ€ä¿®æ”¹åˆå¹¶æˆä¸€æ¬¡çŠ¶æ€ä¿®æ”¹ã€‚ æœ€ç»ˆæ›´æ–°åªäº§ç”Ÿä¸€æ¬¡ç»„ä»¶åŠå…¶å­ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ï¼Œè¿™å¯¹äºå¤§å‹åº”ç”¨ç¨‹åºä¸­çš„æ€§èƒ½æå‡è‡³å…³é‡è¦ã€‚

æ‰¹é‡æ›´æ–°çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š

```js
this.setState({
  count: this.state.count + 1    // ===>    å…¥é˜Ÿï¼Œ[count+1çš„ä»»åŠ¡]
});
this.setState({
  count: this.state.count + 1   //  ===>    å…¥é˜Ÿï¼Œ[count+1çš„ä»»åŠ¡ï¼Œcount+1çš„ä»»åŠ¡]
});
                               //           â†“
                               //          åˆå¹¶ stateï¼Œ[count+1çš„ä»»åŠ¡]
                               //           â†“
                               //          æ‰§è¡Œ count+1çš„ä»»åŠ¡
```



**æ³¨æ„ï¼š**åœ¨ React ä¸­ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨ this.state.key = value æ–¹å¼æ¥æ›´æ–°çŠ¶æ€ï¼Œè¿™ç§æ–¹å¼ React å†…éƒ¨æ— æ³•çŸ¥é“æˆ‘ä»¬ä¿®æ”¹äº†ç»„ä»¶ï¼Œå› æ­¤ä¹Ÿå°±æ²¡åŠæ³•æ›´æ–°åˆ°ç•Œé¢ä¸Šã€‚æ‰€ä»¥ä¸€å®šè¦ä½¿ç”¨ React æä¾›çš„ setState æ–¹æ³•æ¥æ›´æ–°ç»„ä»¶çš„çŠ¶æ€ã€‚

é‚£ ä¸ºä»€ä¹ˆ setState æ˜¯å¼‚æ­¥çš„ï¼Œè¿™ä¸ªé—®é¢˜å¾—åˆ°äº† React å®˜æ–¹å›¢é˜Ÿçš„å›å¤ï¼ŒåŸå› æœ‰ä¸¤ä¸ªï¼š

- 1. ä¿æŒå†…éƒ¨ä¸€è‡´æ€§ã€‚å¦‚æœæ”¹ä¸ºåŒæ­¥æ›´æ–°çš„æ–¹å¼ï¼Œå°½ç®¡ setState å˜æˆäº†åŒæ­¥ï¼Œä½†æ˜¯ props ä¸æ˜¯ã€‚
     ä¸ºåç»­çš„æ¶æ„å‡çº§å¯ç”¨å¹¶å‘æ›´æ–°ã€‚ä¸ºäº†å®Œæˆå¼‚æ­¥æ¸²æŸ“ï¼ŒReact ä¼šåœ¨ setState æ—¶ï¼Œæ ¹æ®å®ƒä»¬çš„æ•°æ®æ¥æºåˆ†é…ä¸åŒçš„ä¼˜å…ˆçº§ï¼Œè¿™äº›æ•°æ®æ¥æºæœ‰ï¼šäº‹ä»¶å›è°ƒå¥æŸ„ã€åŠ¨ç”»æ•ˆæœç­‰ï¼Œå†æ ¹æ®ä¼˜å…ˆçº§å¹¶å‘å¤„ç†ï¼Œæå‡æ¸²æŸ“æ€§èƒ½ã€‚

- 1. setState åŒæ­¥åœºæ™¯
     ä¸Šé¢çš„ä¾‹å­ä½¿æˆ‘ä»¬å»ºç«‹äº†è¿™æ ·ä¸€ä¸ªè®¤çŸ¥ï¼šsetState æ˜¯å¼‚æ­¥çš„ï¼Œä½†ä¸‹é¢è¿™ä¸ªæ¡ˆä¾‹åˆä¼šé¢ è¦†ä½ çš„è®¤çŸ¥ã€‚å¦‚æœæˆ‘ä»¬å°† setState æ”¾åœ¨ setTimeout äº‹ä»¶ä¸­ï¼Œé‚£æƒ…å†µå°±å®Œå…¨ä¸åŒäº†ï¼š

  ```jsx
  class Test extends Component {
      state = {
          count: 0
      }
      componentDidMount(){
          this.setState({ count: this.state.count + 1 });
          console.log(this.state.count);
          setTimeout(() => {
            this.setState({ count: this.state.count + 1 });
            console.log("setTimeout: " + this.state.count);
          }, 0);
      }
      render(){
          ...
      }
  }
  ```

  è¿™æ—¶å°±ä¼šè¾“å‡º 0ï¼Œ2ã€‚å› ä¸º setState å¹¶ä¸æ˜¯çœŸæ­£çš„å¼‚æ­¥å‡½æ•°ï¼Œå®ƒå®é™…ä¸Šæ˜¯é€šè¿‡é˜Ÿåˆ—å»¶è¿Ÿæ‰§è¡Œæ“ä½œå®ç°çš„ï¼Œé€šè¿‡ isBatchingUpdates æ¥åˆ¤æ–­ setState æ˜¯å…ˆå­˜è¿› state é˜Ÿåˆ—è¿˜æ˜¯ç›´æ¥æ›´æ–°ã€‚å€¼ä¸º true åˆ™æ‰§è¡Œå¼‚æ­¥æ“ä½œï¼Œfalse åˆ™ç›´æ¥åŒæ­¥æ›´æ–°ã€‚

  åœ¨ onClickã€onFocus ç­‰äº‹ä»¶ä¸­ï¼Œç”±äºåˆæˆäº‹ä»¶å°è£…äº†ä¸€å±‚ï¼Œæ‰€ä»¥å¯ä»¥å°† isBatchingUpdates çš„çŠ¶æ€æ›´æ–°ä¸º trueï¼›åœ¨ React çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸­ï¼ŒåŒæ ·å¯ä»¥å°† isBatchingUpdates çš„çŠ¶æ€æ›´æ–°ä¸º trueã€‚é‚£ä¹ˆåœ¨ React è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å’Œåˆæˆäº‹ä»¶ä¸­ï¼Œå¯ä»¥æ‹¿åˆ° isBatchingUpdates çš„æ§åˆ¶æƒï¼Œå°†çŠ¶æ€æ”¾è¿›é˜Ÿåˆ—ï¼Œæ§åˆ¶æ‰§è¡ŒèŠ‚å¥ã€‚è€Œåœ¨å¤–éƒ¨çš„åŸç”Ÿäº‹ä»¶ä¸­ï¼Œå¹¶æ²¡æœ‰å¤–å±‚çš„å°è£…ä¸æ‹¦æˆªï¼Œæ— æ³•æ›´æ–° isBatchingUpdates çš„çŠ¶æ€ä¸º trueã€‚è¿™å°±é€ æˆ isBatchingUpdates çš„çŠ¶æ€åªä¼šä¸º falseï¼Œä¸”ç«‹å³æ‰§è¡Œã€‚æ‰€ä»¥åœ¨ addEventListener ã€setTimeoutã€setInterval è¿™äº›åŸç”Ÿäº‹ä»¶ä¸­éƒ½ä¼šåŒæ­¥æ›´æ–°ã€‚

  å®é™…ä¸Šï¼ŒsetState å¹¶ä¸æ˜¯å…·å¤‡åŒæ­¥è¿™ç§ç‰¹æ€§ï¼Œåªæ˜¯åœ¨ç‰¹å®šçš„æƒ…å¢ƒä¸‹ï¼Œå®ƒä¼šä» React çš„å¼‚æ­¥ç®¡æ§ä¸­â€œé€ƒè„±â€æ‰ã€‚

#### äºŒã€setStateå‘ç”Ÿäº†ä»€ä¹ˆ

ä¿®æ”¹ state æ–¹æ³•æœ‰ä¸¤ç§ï¼š

- æ„é€ å‡½æ•°é‡Œä¿®æ”¹ state ï¼Œåªéœ€è¦ç›´æ¥æ“ä½œ this.state å³å¯ï¼Œ å¦‚æœåœ¨æ„é€ å‡½æ•°é‡Œæ‰§è¡Œäº†å¼‚æ­¥æ“ä½œï¼Œå°±éœ€è¦è°ƒç”¨ setState æ¥è§¦å‘é‡æ–°æ¸²æŸ“ã€‚
- åœ¨å…¶ä½™çš„åœ°æ–¹éœ€è¦æ”¹å˜ state çš„æ—¶å€™åªèƒ½ä½¿ç”¨ setStateï¼Œè¿™æ · React æ‰ä¼šè§¦å‘ UI æ›´æ–°ã€‚
  æ‰€ä»¥ï¼Œ setState æ—¶ä¼šè®¾ç½®æ–°çš„ state å¹¶æ›´æ–° UIã€‚å½“ç„¶ï¼Œstate çš„æ›´æ–°å¯èƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå‡ºäºæ€§èƒ½è€ƒè™‘ï¼ŒReact å¯èƒ½ä¼šæŠŠå¤šä¸ª setState è°ƒç”¨åˆå¹¶æˆä¸€ä¸ªè°ƒç”¨ã€‚é‚£ä¹ˆ state çš„æ›´æ–°ä½•æ—¶æ˜¯åŒæ­¥ä½•æ—¶åˆæ˜¯å¼‚æ­¥çš„å‘¢ï¼Ÿ

![setStateå‘ç”Ÿäº†ä»€ä¹ˆ](D:\èœ—ç‰›å­¦è‹‘\é¢è¯•é¢˜\11æœŸé¢è¯•é¢˜\day001\images\setStateå‘ç”Ÿäº†ä»€ä¹ˆ.png)

ï¼ˆ1ï¼‰setState
ä¸‹é¢æ¥çœ‹ä¸‹æ¯ä¸€æ­¥çš„æºç ï¼Œé¦–å…ˆæ˜¯ setState å…¥å£å‡½æ•°ï¼š

```js
ReactComponent.prototype.setState = function (partialState, callback) {
  this.updater.enqueueSetState(this, partialState);
  if (callback) {
    this.updater.enqueueCallback(this, callback, "setState");
  }
};
```

**å…¥å£å‡½æ•°åœ¨è¿™é‡Œå°±æ˜¯å……å½“ä¸€ä¸ªåˆ†å‘å™¨çš„è§’è‰²ï¼Œæ ¹æ®å…¥å‚çš„ä¸åŒï¼Œå°†å…¶åˆ†å‘åˆ°ä¸åŒçš„åŠŸèƒ½å‡½æ•°ä¸­å»ã€‚**è¿™é‡Œæˆ‘ä»¬ä»¥å¯¹è±¡å½¢å¼çš„å…¥å‚ä¸ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ°å®ƒç›´æ¥è°ƒç”¨äº† this.updater.enqueueSetState è¿™ä¸ªæ–¹æ³•ã€‚

2ï¼‰enqueueSetState

```js
enqueueSetState: function (publicInstance, partialState) {
  // æ ¹æ® this æ‹¿åˆ°å¯¹åº”çš„ç»„ä»¶å®ä¾‹
  var internalInstance = getInternalInstanceReadyForUpdate(publicInstance, 'setState');
  // è¿™ä¸ª queue å¯¹åº”çš„å°±æ˜¯ä¸€ä¸ªç»„ä»¶å®ä¾‹çš„ state æ•°ç»„
  var queue = internalInstance._pendingStateQueue || (internalInstance._pendingStateQueue = []);
  queue.push(partialState);
  //  enqueueUpdate ç”¨æ¥å¤„ç†å½“å‰çš„ç»„ä»¶å®ä¾‹
  enqueueUpdate(internalInstance);
}
```

è¿™é‡Œ enqueueSetState åšäº†ä¸¤ä»¶äº‹ï¼š

- 1.å°†æ–°çš„ state æ”¾è¿›ç»„ä»¶çš„çŠ¶æ€é˜Ÿåˆ—é‡Œï¼›
- 2.ç”¨ enqueueUpdate æ¥å¤„ç†å°†è¦æ›´æ–°çš„å®ä¾‹å¯¹è±¡ã€‚

ï¼ˆ3ï¼‰enqueueUpdate

```js
function enqueueUpdate(component) {
  ensureInjected();
  // æ³¨æ„è¿™ä¸€å¥æ˜¯é—®é¢˜çš„å…³é”®ï¼ŒisBatchingUpdatesæ ‡è¯†ç€å½“å‰æ˜¯å¦å¤„äºæ‰¹é‡åˆ›å»º/æ›´æ–°ç»„ä»¶çš„é˜¶æ®µ
  if (!batchingStrategy.isBatchingUpdates) {
    // è‹¥å½“å‰æ²¡æœ‰å¤„äºæ‰¹é‡åˆ›å»º/æ›´æ–°ç»„ä»¶çš„é˜¶æ®µï¼Œåˆ™ç«‹å³æ›´æ–°ç»„ä»¶
    batchingStrategy.batchedUpdates(enqueueUpdate, component);
    return;
  }
  // å¦åˆ™ï¼Œå…ˆæŠŠç»„ä»¶å¡å…¥ dirtyComponents é˜Ÿåˆ—é‡Œï¼Œè®©å®ƒâ€œå†ç­‰ç­‰â€
  dirtyComponents.push(component);
  if (component._updateBatchNumber == null) {
    component._updateBatchNumber = updateBatchNumber + 1;
  }
}
```

è¿™ä¸ª enqueueUpdate å¼•å‡ºäº†ä¸€ä¸ªå…³é”®çš„å¯¹è±¡â€”â€”batchingStrategyï¼Œè¯¥å¯¹è±¡æ‰€å…·å¤‡çš„ isBatchingUpdates å±æ€§ç›´æ¥å†³å®šäº†å½“ä¸‹æ˜¯è¦èµ°æ›´æ–°æµç¨‹ï¼Œè¿˜æ˜¯åº”è¯¥æ’é˜Ÿç­‰å¾…ï¼›å…¶ä¸­çš„ batchedUpdates æ–¹æ³•æ›´æ˜¯èƒ½å¤Ÿç›´æ¥å‘èµ·æ›´æ–°æµç¨‹ã€‚ç”±æ­¤å¯ä»¥æ¨æµ‹ï¼ŒbatchingStrategy æˆ–è®¸æ­£æ˜¯ React å†…éƒ¨ä¸“é—¨ç”¨äºç®¡æ§æ‰¹é‡æ›´æ–°çš„å¯¹è±¡ã€‚

ï¼ˆ4ï¼‰batchingStrategy

```js
var ReactDefaultBatchingStrategy = {
  // å…¨å±€å”¯ä¸€çš„é”æ ‡è¯†
  isBatchingUpdates: false,
  // å‘èµ·æ›´æ–°åŠ¨ä½œçš„æ–¹æ³•
  batchedUpdates: function (callback, a, b, c, d, e) {
    // ç¼“å­˜é”å˜é‡
    var alreadyBatchingStrategy =
      ReactDefaultBatchingStrategy.isBatchingUpdates;
    // æŠŠé”â€œé”ä¸Šâ€
    ReactDefaultBatchingStrategy.isBatchingUpdates = true;
    if (alreadyBatchingStrategy) {
      callback(a, b, c, d, e);
    } else {
      // å¯åŠ¨äº‹åŠ¡ï¼Œå°† callback æ”¾è¿›äº‹åŠ¡é‡Œæ‰§è¡Œ
      transaction.perform(callback, null, a, b, c, d, e);
    }
  },
};
```

batchingStrategy å¯¹è±¡å¯ä»¥ç†è§£ä¸ºå®ƒæ˜¯ä¸€ä¸ªâ€œé”ç®¡ç†å™¨â€ã€‚

è¿™é‡Œçš„â€œé”â€ï¼Œæ˜¯æŒ‡ React å…¨å±€å”¯ä¸€çš„ isBatchingUpdates å˜é‡ï¼ŒisBatchingUpdates çš„åˆå§‹å€¼æ˜¯ falseï¼Œæ„å‘³ç€â€œå½“å‰å¹¶æœªè¿›è¡Œä»»ä½•æ‰¹é‡æ›´æ–°æ“ä½œâ€ã€‚æ¯å½“ React è°ƒç”¨ batchedUpdate å»æ‰§è¡Œæ›´æ–°åŠ¨ä½œæ—¶ï¼Œä¼šå…ˆæŠŠè¿™ä¸ªé”ç»™â€œé”ä¸Šâ€ï¼ˆç½®ä¸º trueï¼‰ï¼Œè¡¨æ˜â€œç°åœ¨æ­£å¤„äºæ‰¹é‡æ›´æ–°è¿‡ç¨‹ä¸­â€ã€‚å½“é”è¢«â€œé”ä¸Šâ€çš„æ—¶å€™ï¼Œä»»ä½•éœ€è¦æ›´æ–°çš„ç»„ä»¶éƒ½åªèƒ½æš‚æ—¶è¿›å…¥ dirtyComponents é‡Œæ’é˜Ÿç­‰å€™ä¸‹ä¸€æ¬¡çš„æ‰¹é‡æ›´æ–°ï¼Œè€Œä¸èƒ½éšæ„â€œæ’é˜Ÿâ€ã€‚æ­¤å¤„ä½“ç°çš„â€œä»»åŠ¡é”â€çš„æ€æƒ³ï¼Œæ˜¯ React é¢å¯¹å¤§é‡çŠ¶æ€ä»ç„¶èƒ½å¤Ÿå®ç°æœ‰åºåˆ†æ‰¹å¤„ç†çš„åŸºçŸ³ã€‚**



#### ä¸‰ã€æ€»ç»“

å¯¹äºé‚£é“å¸¸è€ƒçš„é¢è¯•é¢˜ï¼šsetState æ˜¯åŒæ­¥æ›´æ–°è¿˜æ˜¯å¼‚æ­¥æ›´æ–°ï¼Ÿ æˆ‘ä»¬å¿ƒä¸­æˆ–è®¸å·²ç»æœ‰äº†ç­”æ¡ˆã€‚

setState å¹¶ä¸æ˜¯å•çº¯åŒæ­¥/å¼‚æ­¥çš„ï¼Œå®ƒçš„è¡¨ç°ä¼šå› è°ƒç”¨åœºæ™¯çš„ä¸åŒè€Œä¸åŒï¼šåœ¨ React é’©å­å‡½æ•°åŠåˆæˆäº‹ä»¶ä¸­ï¼Œå®ƒè¡¨ç°ä¸ºå¼‚æ­¥ï¼›è€Œåœ¨ setTimeoutã€setInterval ç­‰å‡½æ•°ä¸­ï¼ŒåŒ…æ‹¬åœ¨ DOM åŸç”Ÿäº‹ä»¶ä¸­ï¼Œå®ƒéƒ½è¡¨ç°ä¸ºåŒæ­¥ã€‚è¿™ç§å·®å¼‚ï¼Œæœ¬è´¨ä¸Šæ˜¯ç”± React äº‹åŠ¡æœºåˆ¶å’Œæ‰¹é‡æ›´æ–°æœºåˆ¶çš„å·¥ä½œæ–¹å¼æ¥å†³å®šçš„ã€‚

åœ¨æºç ä¸­ï¼Œé€šè¿‡ isBatchingUpdates æ¥åˆ¤æ–­ setState æ˜¯å…ˆå­˜è¿› state é˜Ÿåˆ—è¿˜æ˜¯ç›´æ¥æ›´æ–°ï¼Œå¦‚æœå€¼ä¸º true åˆ™æ‰§è¡Œå¼‚æ­¥æ“ä½œï¼Œä¸º false åˆ™ç›´æ¥æ›´æ–°ã€‚

é‚£ä»€ä¹ˆæƒ…å†µä¸‹ isBatchingUpdates ä¼šä¸º true å‘¢ï¼Ÿ

åœ¨ React å¯ä»¥æ§åˆ¶çš„åœ°æ–¹ï¼ŒisBatchingUpdates å°±ä¸º trueï¼Œæ¯”å¦‚åœ¨ React ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å’Œåˆæˆäº‹ä»¶ä¸­ï¼Œéƒ½ä¼šèµ°åˆå¹¶æ“ä½œï¼Œå»¶è¿Ÿæ›´æ–°çš„ç­–ç•¥ã€‚
åœ¨ React æ— æ³•æ§åˆ¶çš„åœ°æ–¹ï¼Œæ¯”å¦‚åŸç”Ÿäº‹ä»¶ï¼Œå…·ä½“å°±æ˜¯åœ¨ addEventListener ã€setTimeoutã€setInterval ç­‰äº‹ä»¶ä¸­ï¼Œå°±åªèƒ½åŒæ­¥æ›´æ–°ã€‚
ä¸€èˆ¬è®¤ä¸ºï¼Œåšå¼‚æ­¥è®¾è®¡æ˜¯ä¸ºäº†æ€§èƒ½ä¼˜åŒ–ã€å‡å°‘æ¸²æŸ“æ¬¡æ•°ï¼ŒReact å›¢é˜Ÿè¿˜è¡¥å……äº†ä¸¤ç‚¹ï¼š

ä¿æŒå†…éƒ¨ä¸€è‡´æ€§ã€‚å¦‚æœå°† state æ”¹ä¸ºåŒæ­¥æ›´æ–°ï¼Œé‚£å°½ç®¡ state çš„æ›´æ–°æ˜¯åŒæ­¥çš„ï¼Œä½†æ˜¯ props ä¸æ˜¯ã€‚
å¯ç”¨å¹¶å‘æ›´æ–°ï¼Œå®Œæˆå¼‚æ­¥æ¸²æŸ“ã€‚
é™„ä¸€ä¸ªå¸¸è€ƒçš„é¢è¯•é¢˜ï¼š

```js
class Test extends React.Component {
  state = {
    count: 0,
  };
  componentDidMount() {
    this.setState({ count: this.state.count + 1 });
    console.log(this.state.count);
    this.setState({ count: this.state.count + 1 });
    console.log(this.state.count);
    setTimeout(() => {
      this.setState({ count: this.state.count + 1 });
      console.log(this.state.count);
      this.setState({ count: this.state.count + 1 });
      console.log(this.state.count);
    }, 0);
  }
  render() {
    return null;
  }
}
```

é¦–å…ˆç¬¬ä¸€æ¬¡å’Œç¬¬äºŒæ¬¡çš„ console.logï¼Œéƒ½åœ¨ React çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä¸­ï¼Œæ‰€ä»¥æ˜¯å¼‚æ­¥çš„å¤„ç†æ–¹å¼ï¼Œåˆ™è¾“å‡ºéƒ½ä¸º 0ï¼›
è€Œåœ¨ setTimeout ä¸­çš„ console.log å¤„äºåŸç”Ÿäº‹ä»¶ä¸­ï¼Œæ‰€ä»¥ä¼šåŒæ­¥çš„å¤„ç†å†è¾“å‡ºç»“æœï¼Œä½†éœ€è¦æ³¨æ„ï¼Œè™½ç„¶ count åœ¨å‰é¢ç»è¿‡äº†ä¸¤æ¬¡çš„ this.state.count + 1ï¼Œä½†æ˜¯æ¯æ¬¡è·å–çš„ this.state.count éƒ½æ˜¯åˆå§‹åŒ–æ—¶çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ 0ï¼›
æ‰€ä»¥æ­¤æ—¶ count æ˜¯ 1ï¼Œé‚£ä¹ˆåç»­åœ¨ setTimeout ä¸­çš„è¾“å‡ºåˆ™æ˜¯ 2 å’Œ 3ã€‚
æ‰€ä»¥ç­”æ¡ˆæ˜¯ 0,0,2,3ã€‚





### Reactä¸­setStateçš„ç¬¬äºŒä¸ªå‚æ•°ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

reacté‡Œçš„setstateæ–¹æ³•é€šå¸¸æƒ…å†µä¸‹æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥æ€ä¹ˆè®©æˆ‘ä»¬çš„ä»£ç ä½¿ç”¨çš„æ˜¯setStateåçš„æ•°å€¼å‘¢ï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§æ–¹å¼ï¼š

* åœ¨setStateä¸­ä½¿ç”¨ç¬¬äºŒä¸ªå‚æ•°ä½œä¸ºå›è°ƒå‡½æ•°

  è¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯åœ¨setStateæ›´æ–°æ•°æ®å®Œæ¯•å¹¶ä¸”æ¸²æŸ“é¡µé¢åæ‰§è¡Œçš„å›è°ƒå‡½æ•°

  ```jsx
  import React from 'react';
  export default class Demo extends React.Component {
      change = () => {
          this.setState((preState, props) => ({
              count: preState.count + 1
          }), () => {
              console.log('ä¿®æ”¹æˆåŠŸåcount:' + this.state.count);
          });
      }
      render() {
          return (
          	<div>
              	{this.state.count}
                  <button onClick={this.change}>ä¿®æ”¹</button>
              </div>
          )
      }
  }
  ```

* ä½¿ç”¨async/awaitæ–¹å¼

  æŠŠsetStateå‡½æ•°çœ‹åšå¼‚æ­¥å‡½æ•°æ¥æ‰§è¡Œ

  ```jsx
  import React from 'react';
  export default class Demo extends React.Component {
      change = async () => {
          async this.setState((preState, props) => ({
              count: preState.count + 1
          }));
          console.log(this.state.count);
      }
      render() {
          return (
          	<div>
              	{this.state.count}
                  <button onClick={this.change}>ä¿®æ”¹</button>
              </div>
          )
      }
  }
  ```

æ—¢ç„¶setStateçš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯æŒ‡stateæ›´æ–°å®Œæ¯•å¹¶æ¸²æŸ“ç»„ä»¶åæ‰§è¡Œçš„å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨componentDidUpdateç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸­æ‰§è¡Œç›¸å…³çš„æ“ä½œã€‚



### åœ¨Reactä¸­ç»„ä»¶çš„this.stateå’ŒsetStateæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

#### ä¸€ã€ç›´æ¥é€šè¿‡this.stateä¿®æ”¹stateé‡Œé¢çš„å€¼

è¿™ç§æ–¹å¼çŸ¥è¯†ä¿®æ”¹stateçš„å€¼ï¼Œä½†æ˜¯ä¸ä¼šå¼•èµ·ç»„ä»¶çš„æ¸²æŸ“ï¼Œæ‰€ä»¥æµè§ˆå™¨é‡Œæ˜¾ç¤ºçš„æ•°æ®è¿˜æ˜¯åŸæ¥çš„æ•°æ®ã€‚

æ˜¯å¦ç›´æ¥ä¿®æ”¹`this.state`çš„å€¼è¿˜å–å†³ä½ çš„ä¸šåŠ¡éœ€æ±‚ï¼Œå‡å¦‚ä½ åœ¨å­ç»„ä»¶çš„çŠ¶æ€æå‡ä¸­è·å¾—ä¸€ä¸ªå€¼çš„æ›´æ–°ï¼Œè€Œä½ çš„è¿™ä¸ªå€¼åˆåœ¨`state`ä¸­çš„æŸä¸ªå¯¹è±¡ä¸­ï¼Œä½ éœ€è¦æ›´æ–°è¿™ä¸ªå¯¹è±¡ç„¶åå†æ“ä½œå¦‚å‘èµ·`axios`è¯·æ±‚ï¼Œè¿™ç§ä¸éœ€è¦æ›´æ–°UIå†…å®¹çš„æƒ…å†µä¸‹å¯ä»¥ä¸´æ—¶ä¿®æ”¹`state`ä¸­çš„æ•°æ®ã€‚åˆç†ä½¿ç”¨stateçš„å…³é”®æ˜¯ `state`ä½œä¸ºä¸€ä¸ªè¢«Reactç‰¹æ®Šçœ‹å¾…çš„å¯¹è±¡ï¼Œä½†å…¶å®å®ƒä¸æ™®é€šæ•°æ®å¯¹è±¡æ— å·®å¼‚ï¼Œä¸è®©ç›´æ¥æ›´æ–°`state`çš„åŸå› æ˜¯åœ¨åç»­æ‰§è¡Œ`setState`è¿‡ç¨‹ä¸­ä¼šè¦†ç›–æˆ–è€…å›é€€ä¹‹å‰åªä¿®æ”¹`state`è€Œæ²¡æœ‰`setState`çš„é‚£éƒ¨åˆ†`state`å€¼

#### äºŒã€é€šè¿‡setStateæ–¹å¼æ›´æ”¹stateçš„å€¼

é€šè¿‡setStateä¿®æ”¹æ•°æ®å¯ä»¥å¼•èµ·ç»„ä»¶çš„æ¸²æŸ“ï¼Œè¿™æ—¶å€™æµè§ˆå™¨å°±ä¼šå±•ç¤ºæœ€æ–°çš„æ•°æ®ï¼Œç„¶è€Œæ˜¯ä¸æ˜¯åšäº† `this.setState` é¡µé¢æ•°æ®å°±ä¸€å®šä¼šæ­£ç¡®æ›´æ–°å‘¢ï¼Ÿä¹Ÿæœªå¿…è§å¾—ï¼Œæ¥çœ‹ä¸‹è¾¹è¿™ä¸ªç»å…¸ä¾‹å­ï¼š

```jsx
function incrementMultiple() {
    this.setState({ count: this.state.count + 1 });
    this.setState({ count: this.state.count + 1 });
    this.setState({ count: this.state.count + 1 });
}
```

 æŒ‰ `javascript` çš„ç¼–ç¨‹æ€è·¯ï¼Œè¿™æ®µä»£ç çš„æ‰§è¡Œç»“æœåº”è¯¥æ˜¯ `this.state.count` å¢åŠ 3ï¼Œç„¶è€Œå®é™…ç»“æœå¹¶éå¦‚æ­¤ï¼Œåªå¢åŠ äº†1ã€‚

React ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œä¼šå°†å¤šä¸ª setState çš„è°ƒç”¨åˆå¹¶ä¸ºä¸€æ¬¡æ›´æ–°ï¼Œå¹¶ä¸”è¯¥æ›´æ–°è¿‡ç¨‹æ˜¯å¼‚æ­¥çš„[çŠ¶æ€æ›´æ–°åˆå¹¶](http://www.css88.com/react/docs/state-and-lifecycle.html)

**æ­¤æ—¶å°†setStateè°ƒç”¨åå‘ç”Ÿäº†ä»€ä¹ˆè®²ä¸€éã€‚**

#### ä¸‰ã€ä»€ä¹ˆæƒ…å†µä¸‹ä¸èƒ½ä½¿ç”¨setStateå‡½æ•°

##### é˜²æ­¢å¾ªç¯è°ƒç”¨

éƒ¨åˆ†reactæ–°æ‰‹å¯èƒ½å’Œæˆ‘é‡åˆ°è¿‡ç›¸åŒçš„é—®é¢˜ï¼Œå³åœ¨è®¾ç½®å¼€å‘è¿‡ç¨‹ä¸­çªç„¶å‘ç°æµè§ˆå™¨éå¸¸å®¹æ˜“å¡æ­»ï¼Œä»”ç»†ä¸€ä¸ªæ§åˆ¶å°æ‰çŸ¥é“æœ‰ä¸ªæ¥å£ä¸€ç›´åœ¨ä¸åœçš„å‘èµ·é€’å½’è°ƒç”¨ç›´è‡³ç”µè„‘å†…å­˜ä¸è¶³
  ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œ`updateComponent` æ–¹æ³•ä¼šè°ƒç”¨ `shouldComponentUpdate` å’Œ
 `componentWillUpdate` æ–¹æ³•ã€‚å› æ­¤ï¼Œä¸è¦åœ¨ `shouldComponentUpdate` å’Œ
 `componentWillUpdate` ä¸­è°ƒç”¨ `setState` ã€‚å¦‚æœåœ¨è¿™ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸé‡Œè°ƒç”¨ `setState` ï¼Œä¼šé€ æˆé€ æˆå¾ªç¯è°ƒç”¨ã€‚



### é«˜é˜¶ç»„ä»¶çš„å®ç°æºç ä½ çŸ¥é“å—ï¼Ÿ

æ¨èæ–‡ç« ï¼š<https://juejin.cn/post/6940422320427106335?share_token=0537e11f-d076-41ce-ab05-77e3f6b231bc>

#### ä¸€ã€å‰è¨€

`React`é«˜é˜¶ç»„ä»¶(`HOC`)ï¼Œå¯¹äºå¾ˆå¤š`react`å¼€å‘è€…æ¥è¯´å¹¶ä¸é™Œç”Ÿï¼Œå®ƒæ˜¯çµæ´»ä½¿ç”¨`react`ç»„ä»¶çš„ä¸€ç§æŠ€å·§ï¼Œé«˜é˜¶ç»„ä»¶æœ¬èº«ä¸æ˜¯ç»„ä»¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªå‚æ•°ä¸ºç»„ä»¶ï¼Œè¿”å›å€¼ä¹Ÿæ˜¯ä¸€ä¸ªç»„ä»¶çš„å‡½æ•°ã€‚é«˜é˜¶ä½œç”¨ç”¨äº**å¼ºåŒ–ç»„ä»¶ï¼Œå¤ç”¨é€»è¾‘ï¼Œæå‡æ¸²æŸ“æ€§èƒ½ç­‰**ä½œç”¨ã€‚é«˜é˜¶ç»„ä»¶ä¹Ÿå¹¶ä¸æ˜¯å¾ˆéš¾ç†è§£ï¼Œå…¶å®æ¥è§¦è¿‡åè¿˜æ˜¯è›®ç®€å•çš„ï¼Œæ¥ä¸‹æ¥æˆ‘å°†æŒ‰ç…§ï¼Œ**é«˜é˜¶ç»„ä»¶ç†è§£ï¼Ÿ**ï¼Œ**é«˜é˜¶ç»„ä»¶å…·ä½“æ€ä¹ˆä½¿ç”¨ï¼Ÿåº”ç”¨åœºæ™¯**ï¼Œ **é«˜é˜¶ç»„ä»¶å®è·µ(æºç çº§åˆ«)** ä¸ºçªç ´å£ï¼Œå¸¦å¤§å®¶è¯¦ç»†äº†è§£ä¸€ä¸‹é«˜é˜¶ç»„ä»¶ã€‚

#### äºŒã€å¦‚ä½•ç¼–å†™é«˜é˜¶ç»„ä»¶

##### ï¼ˆ1ï¼‰å¼ºåŒ–props

* æ··å…¥props

  ```jsx
  function HOC(Component) {
    return class wrapComponent extends React.Component{
       constructor(){
         super()
         this.state={
           name:'alien'
         }
       }
       render=()=><Component { ...this.props } { ...this.state } />
    }
  }
  ```

  ä¿®é¥°å™¨æ–¹å¼ä½¿ç”¨

  ```jsx
  import HOC from './HOC';
  @HOC
  class Index extends React.Component{
    say(){
      const { name } = this.props
      console.log(name)
    }
    render(){
      return <div> hello,world <button onClick={ this.say.bind(this) } >ç‚¹å‡»</button>  </div>
    }
  }
  ```

  å‡½æ•°å¼æ–¹å¼ä½¿ç”¨

  ```jsx
  import HOC from './HOC';
  class Index extends React.Component{
    say(){
      const { name } = this.props
      console.log(name)
    }
    render(){
      return <div> hello,world <button onClick={ this.say.bind(this) } >ç‚¹å‡»</button>  </div>
    }
  }
  
  HOC(Index);
  ```

* æŠ½ç¦»stateæ§åˆ¶æ›´æ–°

  é«˜é˜¶ç»„ä»¶å¯ä»¥å°†`HOC`çš„`state`çš„é…åˆèµ·æ¥ï¼Œæ§åˆ¶ä¸šåŠ¡ç»„ä»¶çš„æ›´æ–°ã€‚è¿™ç§ç”¨æ³•åœ¨`react-redux`ä¸­`connect`é«˜é˜¶ç»„ä»¶ä¸­ç”¨åˆ°è¿‡ï¼Œç”¨äºå¤„ç†æ¥è‡ª`redux`ä¸­`state`æ›´æ”¹ï¼Œå¸¦æ¥çš„è®¢é˜…æ›´æ–°ä½œç”¨ã€‚

  ```jsx
  function classHOC(WrapComponent){
    return class  Idex extends React.Component{
        constructor(){
          super()
          this.state={
            name:'alien'
          }
        }
        changeName(name){
          this.setState({ name })
        }
        render(){
            return <WrapComponent { ...this.props }  { ...this.state } changeName={this.changeName.bind(this)  }  />
        }
    }
  }
  function Index(props){
    const [ value ,setValue ] = useState(null)
    const { name ,changeName } = props
    return <div>
      <div>   hello,world , my name is { name }</div>
      æ”¹å˜name <input onChange={ (e)=> setValue(e.target.value)  }  />
      <button onClick={ ()=>  changeName(value) }  >ç¡®å®š</button>
    </div>
  }
  
  export default classHOC(Index)
  ```

##### ï¼ˆ2ï¼‰æ¡ä»¶æ¸²æŸ“

* åŠ¨æ€æ¸²æŸ“

  å¯¹äºå±æ€§ä»£ç†çš„é«˜é˜¶ç»„ä»¶ï¼Œè™½ç„¶ä¸èƒ½åœ¨å†…éƒ¨æ“æ§æ¸²æŸ“çŠ¶æ€ï¼Œä½†æ˜¯å¯ä»¥åœ¨å¤–å±‚æ§åˆ¶å½“å‰ç»„ä»¶æ˜¯å¦æ¸²æŸ“ï¼Œè¿™ç§æƒ…å†µåº”ç”¨äºï¼Œ**æƒé™éš”ç¦»**ï¼Œ**æ‡’åŠ è½½** ï¼Œ**å»¶æ—¶åŠ è½½**ç­‰åœºæ™¯ã€‚

  **å®ç°ä¸€ä¸ªåŠ¨æ€æŒ‚è½½ç»„ä»¶çš„HOC**

  ```jsx
  function renderHOC(WrapComponent){
    return class Index  extends React.Component{
        constructor(props){
          super(props)
          this.state={ visible:true }  
        }
        setVisible(){
           this.setState({ visible:!this.state.visible })
        }
        render(){
           const {  visible } = this.state 
           return <div className="box"  >
             <button onClick={ this.setVisible.bind(this) } > æŒ‚è½½ç»„ä»¶ </button>
             { visible ? <WrapComponent { ...this.props } setVisible={ this.setVisible.bind(this) }   />  : <div className="icon" ><SyncOutlined spin  className="theicon"  /></div> }
           </div>
        }
    }
  }
  
  class Index extends React.Component{
    render(){
      const { setVisible } = this.props
      return <div className="box" >
          <p>hello,my name is alien</p>
          <img  src='https://ss2.bdstatic.com/70cFvnSh_Q1YnxGkpoWK1HF6hhy/it/u=294206908,2427609994&fm=26&gp=0.jpg'   /> 
          <button onClick={() => setVisible()}  > å¸è½½å½“å‰ç»„ä»¶ </button>
      </div>
    }
  }
  export default renderHOC(Index)
  ```

* èŠ‚æµæ¸²æŸ“

  `hoc`é™¤äº†å¯ä»¥è¿›è¡Œ**æ¡ä»¶æ¸²æŸ“**ï¼Œ**æ¸²æŸ“åŠ«æŒ**åŠŸèƒ½å¤–ï¼Œè¿˜å¯ä»¥è¿›è¡ŒèŠ‚æµæ¸²æŸ“ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥ä¼˜åŒ–æ€§èƒ½ï¼Œå…·ä½“æ€ä¹ˆåšï¼Œè¯·è·Ÿä¸Šæˆ‘çš„èŠ‚å¥å¾€ä¸‹çœ‹ã€‚`hoc`å¯ä»¥é…åˆ`hooks`çš„`useMemo`ç­‰`API`é…åˆä½¿ç”¨ï¼Œå¯ä»¥å®ç°å¯¹ä¸šåŠ¡ç»„ä»¶çš„æ¸²æŸ“æ§åˆ¶ï¼Œå‡å°‘æ¸²æŸ“æ¬¡æ•°ï¼Œä»è€Œè¾¾åˆ°ä¼˜åŒ–æ€§èƒ½çš„æ•ˆæœã€‚å¦‚ä¸‹æ¡ˆä¾‹ï¼Œæˆ‘ä»¬æœŸæœ›å½“ä¸”ä»…å½“`num`æ”¹å˜çš„æ—¶å€™ï¼Œæ¸²æŸ“ç»„ä»¶ï¼Œä½†æ˜¯ä¸å½±å“æ¥æ”¶çš„`props`ã€‚æˆ‘ä»¬åº”è¯¥è¿™æ ·å†™æˆ‘ä»¬çš„`HOC`ã€‚

  ```js
  function HOC (Component){
       return function renderWrapComponent(props){
         const { num } = props
         const RenderElement = useMemo(() =>  <Component {...props}  /> ,[ num ])
         return RenderElement
       }
  }
  class Index extends React.Component{
    render(){
       console.log(`å½“å‰ç»„ä»¶æ˜¯å¦æ¸²æŸ“`,this.props)
       return <div>hello,world, my name is alien </div>
    }
  }
  const IndexHoc = HOC(Index)
  
  export default ()=> {
      const [ num ,setNumber ] = useState(0)
      const [ num1 ,setNumber1 ] = useState(0)
      const [ num2 ,setNumber2 ] = useState(0)
      return <div>
          <IndexHoc  num={ num } num1={num1} num2={ num2 }  />
          <button onClick={() => setNumber(num + 1) } >num++</button>
          <button onClick={() => setNumber1(num1 + 1) } >num1++</button>
          <button onClick={() => setNumber2(num2 + 1) } >num2++</button>
      </div>
  }
  ```

  ![èŠ‚æµæ¸²æŸ“](D:\èœ—ç‰›å­¦è‹‘\é¢è¯•é¢˜\11æœŸé¢è¯•é¢˜\day001\images\èŠ‚æµæ¸²æŸ“.gif)

  å¦‚å›¾æ‰€ç¤º,å½“æˆ‘ä»¬åªæœ‰ç‚¹å‡» `num++`æ—¶å€™ï¼Œæ‰é‡æ–°æ¸²æŸ“å­ç»„ä»¶ï¼Œç‚¹å‡»å…¶ä»–æŒ‰é’®ï¼Œåªæ˜¯è´Ÿè´£ä¼ é€’äº†`props`,è¾¾åˆ°äº†æœŸæœ›çš„æ•ˆæœã€‚

* å®šåˆ¶åŒ–èŠ‚æµæ¸²æŸ“

  æ€è€ƒï¼šğŸ¤”ä¸Šè¿°çš„æ¡ˆä¾‹åªæ˜¯ä»‹ç»äº†åŸç†ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæ˜¯é‡åŒ–ç”Ÿäº§ä¸äº†çš„ï¼ŒåŸå› æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦é’ˆå¯¹ä¸åŒ`props`å˜åŒ–ï¼Œå†™ä¸åŒçš„`HOC`ç»„ä»¶ï¼Œè¿™æ ·æ ¹æœ¬èµ·ä¸äº†`Hoc`çœŸæ­£çš„ç”¨é€”ï¼Œä¹Ÿå°±æ˜¯`HOC`äº§ç”Ÿçš„åˆè¡·ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹ä¸Šè¿°`hoc`è¿›è¡Œæ”¹é€ å‡çº§ï¼Œæ˜¯ç»„ä»¶å¯ä»¥æ ¹æ®å®šåˆ¶åŒ–æ–¹å‘ï¼Œå»æ¸²æŸ“ç»„ä»¶ã€‚ä¹Ÿå°±æ˜¯`Hoc`ç”Ÿæˆçš„æ—¶å€™ï¼Œå·²ç»æŒ‰ç…§æŸç§å¥‘çº¦å»æ‰§è¡Œæ¸²æŸ“ã€‚

  ```js
  function HOC (rule){
       return function (Component){
          return function renderWrapComponent(props){
            const dep = rule(props)
            const RenderElement = useMemo(() =>  <Component {...props}  /> ,[ dep ])
            return RenderElement
          }
       }
  }
  /* åªæœ‰ props ä¸­ num å˜åŒ– ï¼Œæ¸²æŸ“ç»„ä»¶  */
  @HOC( (props)=> props['num'])
  class IndexHoc extends React.Component{
    render(){
       console.log(`ç»„ä»¶ä¸€æ¸²æŸ“`,this.props)
       return <div> ç»„ä»¶ä¸€ ï¼š hello,world </div>
    }
  }
  
  /* åªæœ‰ props ä¸­ num1 å˜åŒ– ï¼Œæ¸²æŸ“ç»„ä»¶  */
  @HOC((props)=> props['num1'])
  class IndexHoc1 extends React.Component{
    render(){
       console.log(`ç»„ä»¶äºŒæ¸²æŸ“`,this.props)
       return <div> ç»„ä»¶äºŒ ï¼š my name is alien </div>
    }
  }
  export default ()=> {
      const [ num ,setNumber ] = useState(0)
      const [ num1 ,setNumber1 ] = useState(0)
      const [ num2 ,setNumber2 ] = useState(0)
      return <div>
          <IndexHoc  num={ num } num1={num1} num2={ num2 }  />
          <IndexHoc1  num={ num } num1={num1} num2={ num2 }  />
          <button onClick={() => setNumber(num + 1) } >num++</button>
          <button onClick={() => setNumber1(num1 + 1) } >num1++</button>
          <button onClick={() => setNumber2(num2 + 1) } >num2++</button>
      </div>
  }
  ```

  ![å®šåˆ¶åŒ–èŠ‚æµæ¸²æŸ“](D:\èœ—ç‰›å­¦è‹‘\é¢è¯•é¢˜\11æœŸé¢è¯•é¢˜\day001\images\å®šåˆ¶åŒ–èŠ‚æµæ¸²æŸ“.gif)

  å®Œç¾å®ç°äº†æ•ˆæœã€‚è¿™ç”¨é«˜é˜¶ç»„ä»¶æ¨¡å¼ï¼Œå¯ä»¥çµæ´»æ§åˆ¶`React`ç»„ä»¶å±‚é¢ä¸Šçš„ï¼Œ**`props`æ•°æ®æµ**å’Œ**æ›´æ–°æµ**ï¼Œä¼˜ç§€çš„é«˜é˜¶ç»„ä»¶æœ‰ `mobx` ä¸­`observer` ,`inject` , `react-redux`ä¸­çš„`connect`,æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥æŠ½æ—¶é—´ç ”ç©¶ä¸€ä¸‹ã€‚

##### ï¼ˆ3ï¼‰èµ‹èƒ½ç»„ä»¶

é«˜é˜¶ç»„ä»¶é™¤äº†ä¸Šè¿°ä¸¤ç§åŠŸèƒ½ä¹‹å¤–ï¼Œè¿˜å¯ä»¥èµ‹èƒ½ç»„ä»¶ï¼Œæ¯”å¦‚åŠ ä¸€äº›**é¢å¤–`ç”Ÿå‘½å‘¨æœŸ`**ï¼Œ**åŠ«æŒäº‹ä»¶**ï¼Œ**ç›‘æ§æ—¥å¿—**ç­‰ç­‰ã€‚

* åŠ«æŒåŸå‹é“¾-åŠ«æŒç”Ÿå‘½å‘¨æœŸ
  **å±æ€§ä»£ç†å®ç°**

  ```jsx
  function HOC (Component){
    const proDidMount = Component.prototype.componentDidMount 
    Component.prototype.componentDidMount = function(){
       console.log('åŠ«æŒç”Ÿå‘½å‘¨æœŸï¼šcomponentDidMount')
       proDidMount.call(this)
    }
    return class wrapComponent extends React.Component{
        render(){
          return <Component {...this.props}  />
        }
    }
  }
  @HOC
  class Index extends React.Component{
     componentDidMount(){
       console.log('â€”â€”â€”didMountedâ€”â€”â€”')
     }
     render(){
       return <div>hello,world</div>
     }
  }
  ```

  **åå‘ç»§æ‰¿å®ç°**

  åå‘ç»§æ‰¿ï¼Œå› ä¸ºåœ¨ç»§æ‰¿åŸæœ‰ç»„ä»¶çš„åŸºç¡€ä¸Šï¼Œå¯ä»¥å¯¹åŸæœ‰ç»„ä»¶çš„**ç”Ÿå‘½å‘¨æœŸ**æˆ–**äº‹ä»¶**è¿›è¡ŒåŠ«æŒï¼Œç”šè‡³æ˜¯æ›¿æ¢ã€‚

  ```jsx
  function HOC (Component){
    const didMount = Component.prototype.componentDidMount
    return class wrapComponent extends Component{
        componentDidMount(){
          console.log('------åŠ«æŒç”Ÿå‘½å‘¨æœŸ------')
          if (didMount) {
             didMount.apply(this) /* æ³¨æ„ `this` æŒ‡å‘é—®é¢˜ã€‚ */
          }
        }
        render(){
          return super.render()
        }
    }
  }
  
  @HOC
  class Index extends React.Component{
     componentDidMount(){
       console.log('â€”â€”â€”didMountedâ€”â€”â€”')
     }
     render(){
       return <div>hello,world</div>
     }
  }
  ```

* äº‹ä»¶ç›‘æ§

  ```jsx
  function ClickHoc (Component){
    return  function Wrap(props){
      const dom = useRef(null)
      useEffect(()=>{
       const handerClick = () => console.log('å‘ç”Ÿç‚¹å‡»äº‹ä»¶') 
       dom.current.addEventListener('click',handerClick)
       return () => dom.current.removeEventListener('click',handerClick)
      },[])
      return  <div ref={dom}  ><Component  {...props} /></div>
    }
  }
  
  @ClickHoc
  class Index extends React.Component{
     render(){
       return <div  className='index'  >
         <p>helloï¼Œworld</p>
         <button>ç»„ä»¶å†…éƒ¨ç‚¹å‡»</button>
      </div>
     }
  }
  export default ()=>{
    return <div className='box'  >
       <Index />
       <button>ç»„ä»¶å¤–éƒ¨ç‚¹å‡»</button>
    </div>
  }
  
  ```

  