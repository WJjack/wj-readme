## é¢è¯•é¢˜--é«˜é˜¶å‡½æ•°

### ä»€ä¹ˆæ˜¯é«˜é˜¶å‡½æ•°

é«˜é˜¶å‡½æ•°æœ¬è´¨æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå‚æ•°æ˜¯ä¸€ä¸ªç»„ä»¶ï¼Œç»è¿‡å¤„ç†åè¿”å›å†è¿”å›è¿™ä¸ªç»„ä»¶ã€‚

é«˜é˜¶å‡½æ•°çš„åŠŸèƒ½ï¼šå¼ºåŒ–propsã€æ¡ä»¶æ¸²æŸ“ã€èµ‹èƒ½ç»„ä»¶ï¼ˆç”Ÿå‘½å‘¨æœŸæ‹¦æˆªã€äº‹ä»¶åŠ«æŒã€æ‰“å°æ—¥å¿—ï¼‰



### å¦‚ä½•ç¼–å†™é«˜é˜¶ç»„ä»¶

##### ï¼ˆ1ï¼‰å¼ºåŒ–props

* æ··å…¥props

  ```jsx
  function HOC(Component) {
    return class wrapComponent extends React.Component{
       constructor(){
         super()
         this.state={
           name:'alien'
         }
       }
       render=()=><Component { ...this.props } { ...this.state } />
    }
  }
  ```

  ä¿®é¥°å™¨æ–¹å¼ä½¿ç”¨

  ```jsx
  import HOC from './HOC';
  @HOC
  class Index extends React.Component{
    say(){
      const { name } = this.props
      console.log(name)
    }
    render(){
      return <div> hello,world <button onClick={ this.say.bind(this) } >ç‚¹å‡»</button>  </div>
    }
  }
  ```

  å‡½æ•°å¼æ–¹å¼ä½¿ç”¨

  ```jsx
  import HOC from './HOC';
  class Index extends React.Component{
    say(){
      const { name } = this.props
      console.log(name)
    }
    render(){
      return <div> hello,world <button onClick={ this.say.bind(this) } >ç‚¹å‡»</button>  </div>
    }
  }
  
  HOC(Index);
  ```

* æŠ½ç¦»stateæ§åˆ¶æ›´æ–°

  é«˜é˜¶ç»„ä»¶å¯ä»¥å°†`HOC`çš„`state`çš„é…åˆèµ·æ¥ï¼Œæ§åˆ¶ä¸šåŠ¡ç»„ä»¶çš„æ›´æ–°ã€‚è¿™ç§ç”¨æ³•åœ¨`react-redux`ä¸­`connect`é«˜é˜¶ç»„ä»¶ä¸­ç”¨åˆ°è¿‡ï¼Œç”¨äºå¤„ç†æ¥è‡ª`redux`ä¸­`state`æ›´æ”¹ï¼Œå¸¦æ¥çš„è®¢é˜…æ›´æ–°ä½œç”¨ã€‚

  ```jsx
  function classHOC(WrapComponent){
    return class  Idex extends React.Component{
        constructor(){
          super()
          this.state={
            name:'alien'
          }
        }
        changeName(name){
          this.setState({ name })
        }
        render(){
            return <WrapComponent { ...this.props }  { ...this.state } changeName={this.changeName.bind(this)  }  />
        }
    }
  }
  function Index(props){
    const [ value ,setValue ] = useState(null)
    const { name ,changeName } = props
    return <div>
      <div>   hello,world , my name is { name }</div>
      æ”¹å˜name <input onChange={ (e)=> setValue(e.target.value)  }  />
      <button onClick={ ()=>  changeName(value) }  >ç¡®å®š</button>
    </div>
  }
  
  export default classHOC(Index)
  ```

##### ï¼ˆ2ï¼‰æ¡ä»¶æ¸²æŸ“

* åŠ¨æ€æ¸²æŸ“

  å¯¹äºå±æ€§ä»£ç†çš„é«˜é˜¶ç»„ä»¶ï¼Œè™½ç„¶ä¸èƒ½åœ¨å†…éƒ¨æ“æ§æ¸²æŸ“çŠ¶æ€ï¼Œä½†æ˜¯å¯ä»¥åœ¨å¤–å±‚æ§åˆ¶å½“å‰ç»„ä»¶æ˜¯å¦æ¸²æŸ“ï¼Œè¿™ç§æƒ…å†µåº”ç”¨äºï¼Œ**æƒé™éš”ç¦»**ï¼Œ**æ‡’åŠ è½½** ï¼Œ**å»¶æ—¶åŠ è½½**ç­‰åœºæ™¯ã€‚

  **å®ç°ä¸€ä¸ªåŠ¨æ€æŒ‚è½½ç»„ä»¶çš„HOC**

  ```jsx
  function renderHOC(WrapComponent){
    return class Index  extends React.Component{
        constructor(props){
          super(props)
          this.state={ visible:true }  
        }
        setVisible(){
           this.setState({ visible:!this.state.visible })
        }
        render(){
           const {  visible } = this.state 
           return <div className="box"  >
             <button onClick={ this.setVisible.bind(this) } > æŒ‚è½½ç»„ä»¶ </button>
             { visible ? <WrapComponent { ...this.props } setVisible={ this.setVisible.bind(this) }   />  : <div className="icon" ><SyncOutlined spin  className="theicon"  /></div> }
           </div>
        }
    }
  }
  
  class Index extends React.Component{
    render(){
      const { setVisible } = this.props
      return <div className="box" >
          <p>hello,my name is alien</p>
          <img  src='https://ss2.bdstatic.com/70cFvnSh_Q1YnxGkpoWK1HF6hhy/it/u=294206908,2427609994&fm=26&gp=0.jpg'   /> 
          <button onClick={() => setVisible()}  > å¸è½½å½“å‰ç»„ä»¶ </button>
      </div>
    }
  }
  export default renderHOC(Index)
  ```

* èŠ‚æµæ¸²æŸ“

  `hoc`é™¤äº†å¯ä»¥è¿›è¡Œ**æ¡ä»¶æ¸²æŸ“**ï¼Œ**æ¸²æŸ“åŠ«æŒ**åŠŸèƒ½å¤–ï¼Œè¿˜å¯ä»¥è¿›è¡ŒèŠ‚æµæ¸²æŸ“ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥ä¼˜åŒ–æ€§èƒ½ï¼Œå…·ä½“æ€ä¹ˆåšï¼Œè¯·è·Ÿä¸Šæˆ‘çš„èŠ‚å¥å¾€ä¸‹çœ‹ã€‚`hoc`å¯ä»¥é…åˆ`hooks`çš„`useMemo`ç­‰`API`é…åˆä½¿ç”¨ï¼Œå¯ä»¥å®ç°å¯¹ä¸šåŠ¡ç»„ä»¶çš„æ¸²æŸ“æ§åˆ¶ï¼Œå‡å°‘æ¸²æŸ“æ¬¡æ•°ï¼Œä»è€Œè¾¾åˆ°ä¼˜åŒ–æ€§èƒ½çš„æ•ˆæœã€‚å¦‚ä¸‹æ¡ˆä¾‹ï¼Œæˆ‘ä»¬æœŸæœ›å½“ä¸”ä»…å½“`num`æ”¹å˜çš„æ—¶å€™ï¼Œæ¸²æŸ“ç»„ä»¶ï¼Œä½†æ˜¯ä¸å½±å“æ¥æ”¶çš„`props`ã€‚æˆ‘ä»¬åº”è¯¥è¿™æ ·å†™æˆ‘ä»¬çš„`HOC`ã€‚

  ```js
  function HOC (Component){
       return function renderWrapComponent(props){
         const { num } = props
         const RenderElement = useMemo(() =>  <Component {...props}  /> ,[ num ])
         return RenderElement
       }
  }
  class Index extends React.Component{
    render(){
       console.log(`å½“å‰ç»„ä»¶æ˜¯å¦æ¸²æŸ“`,this.props)
       return <div>hello,world, my name is alien </div>
    }
  }
  const IndexHoc = HOC(Index)
  
  export default ()=> {
      const [ num ,setNumber ] = useState(0)
      const [ num1 ,setNumber1 ] = useState(0)
      const [ num2 ,setNumber2 ] = useState(0)
      return <div>
          <IndexHoc  num={ num } num1={num1} num2={ num2 }  />
          <button onClick={() => setNumber(num + 1) } >num++</button>
          <button onClick={() => setNumber1(num1 + 1) } >num1++</button>
          <button onClick={() => setNumber2(num2 + 1) } >num2++</button>
      </div>
  }
  ```

  ![èŠ‚æµæ¸²æŸ“](D:\èœ—ç‰›å­¦è‹‘\é¢è¯•é¢˜\11æœŸé¢è¯•é¢˜\day001\images\èŠ‚æµæ¸²æŸ“.gif)

  å¦‚å›¾æ‰€ç¤º,å½“æˆ‘ä»¬åªæœ‰ç‚¹å‡» `num++`æ—¶å€™ï¼Œæ‰é‡æ–°æ¸²æŸ“å­ç»„ä»¶ï¼Œç‚¹å‡»å…¶ä»–æŒ‰é’®ï¼Œåªæ˜¯è´Ÿè´£ä¼ é€’äº†`props`,è¾¾åˆ°äº†æœŸæœ›çš„æ•ˆæœã€‚

* å®šåˆ¶åŒ–èŠ‚æµæ¸²æŸ“

  æ€è€ƒï¼šğŸ¤”ä¸Šè¿°çš„æ¡ˆä¾‹åªæ˜¯ä»‹ç»äº†åŸç†ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæ˜¯é‡åŒ–ç”Ÿäº§ä¸äº†çš„ï¼ŒåŸå› æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦é’ˆå¯¹ä¸åŒ`props`å˜åŒ–ï¼Œå†™ä¸åŒçš„`HOC`ç»„ä»¶ï¼Œè¿™æ ·æ ¹æœ¬èµ·ä¸äº†`Hoc`çœŸæ­£çš„ç”¨é€”ï¼Œä¹Ÿå°±æ˜¯`HOC`äº§ç”Ÿçš„åˆè¡·ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹ä¸Šè¿°`hoc`è¿›è¡Œæ”¹é€ å‡çº§ï¼Œæ˜¯ç»„ä»¶å¯ä»¥æ ¹æ®å®šåˆ¶åŒ–æ–¹å‘ï¼Œå»æ¸²æŸ“ç»„ä»¶ã€‚ä¹Ÿå°±æ˜¯`Hoc`ç”Ÿæˆçš„æ—¶å€™ï¼Œå·²ç»æŒ‰ç…§æŸç§å¥‘çº¦å»æ‰§è¡Œæ¸²æŸ“ã€‚

  ```js
  function HOC (rule){
       return function (Component){
          return function renderWrapComponent(props){
            const dep = rule(props)
            const RenderElement = useMemo(() =>  <Component {...props}  /> ,[ dep ])
            return RenderElement
          }
       }
  }
  /* åªæœ‰ props ä¸­ num å˜åŒ– ï¼Œæ¸²æŸ“ç»„ä»¶  */
  @HOC( (props)=> props['num'])
  class IndexHoc extends React.Component{
    render(){
       console.log(`ç»„ä»¶ä¸€æ¸²æŸ“`,this.props)
       return <div> ç»„ä»¶ä¸€ ï¼š hello,world </div>
    }
  }
  
  /* åªæœ‰ props ä¸­ num1 å˜åŒ– ï¼Œæ¸²æŸ“ç»„ä»¶  */
  @HOC((props)=> props['num1'])
  class IndexHoc1 extends React.Component{
    render(){
       console.log(`ç»„ä»¶äºŒæ¸²æŸ“`,this.props)
       return <div> ç»„ä»¶äºŒ ï¼š my name is alien </div>
    }
  }
  export default ()=> {
      const [ num ,setNumber ] = useState(0)
      const [ num1 ,setNumber1 ] = useState(0)
      const [ num2 ,setNumber2 ] = useState(0)
      return <div>
          <IndexHoc  num={ num } num1={num1} num2={ num2 }  />
          <IndexHoc1  num={ num } num1={num1} num2={ num2 }  />
          <button onClick={() => setNumber(num + 1) } >num++</button>
          <button onClick={() => setNumber1(num1 + 1) } >num1++</button>
          <button onClick={() => setNumber2(num2 + 1) } >num2++</button>
      </div>
  }
  ```

  ![å®šåˆ¶åŒ–èŠ‚æµæ¸²æŸ“](D:\èœ—ç‰›å­¦è‹‘\é¢è¯•é¢˜\11æœŸé¢è¯•é¢˜\day001\images\å®šåˆ¶åŒ–èŠ‚æµæ¸²æŸ“.gif)

  å®Œç¾å®ç°äº†æ•ˆæœã€‚è¿™ç”¨é«˜é˜¶ç»„ä»¶æ¨¡å¼ï¼Œå¯ä»¥çµæ´»æ§åˆ¶`React`ç»„ä»¶å±‚é¢ä¸Šçš„ï¼Œ**`props`æ•°æ®æµ**å’Œ**æ›´æ–°æµ**ï¼Œä¼˜ç§€çš„é«˜é˜¶ç»„ä»¶æœ‰ `mobx` ä¸­`observer` ,`inject` , `react-redux`ä¸­çš„`connect`,æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥æŠ½æ—¶é—´ç ”ç©¶ä¸€ä¸‹ã€‚

##### ï¼ˆ3ï¼‰èµ‹èƒ½ç»„ä»¶

é«˜é˜¶ç»„ä»¶é™¤äº†ä¸Šè¿°ä¸¤ç§åŠŸèƒ½ä¹‹å¤–ï¼Œè¿˜å¯ä»¥èµ‹èƒ½ç»„ä»¶ï¼Œæ¯”å¦‚åŠ ä¸€äº›**é¢å¤–`ç”Ÿå‘½å‘¨æœŸ`**ï¼Œ**åŠ«æŒäº‹ä»¶**ï¼Œ**ç›‘æ§æ—¥å¿—**ç­‰ç­‰ã€‚

* åŠ«æŒåŸå‹é“¾-åŠ«æŒç”Ÿå‘½å‘¨æœŸ
  **å±æ€§ä»£ç†å®ç°**

  ```jsx
  function HOC (Component){
    const proDidMount = Component.prototype.componentDidMount 
    Component.prototype.componentDidMount = function(){
       console.log('åŠ«æŒç”Ÿå‘½å‘¨æœŸï¼šcomponentDidMount')
       proDidMount.call(this)
    }
    return class wrapComponent extends React.Component{
        render(){
          return <Component {...this.props}  />
        }
    }
  }
  @HOC
  class Index extends React.Component{
     componentDidMount(){
       console.log('â€”â€”â€”didMountedâ€”â€”â€”')
     }
     render(){
       return <div>hello,world</div>
     }
  }
  ```

  **åå‘ç»§æ‰¿å®ç°**

  åå‘ç»§æ‰¿ï¼Œå› ä¸ºåœ¨ç»§æ‰¿åŸæœ‰ç»„ä»¶çš„åŸºç¡€ä¸Šï¼Œå¯ä»¥å¯¹åŸæœ‰ç»„ä»¶çš„**ç”Ÿå‘½å‘¨æœŸ**æˆ–**äº‹ä»¶**è¿›è¡ŒåŠ«æŒï¼Œç”šè‡³æ˜¯æ›¿æ¢ã€‚

  ```jsx
  function HOC (Component){
    const didMount = Component.prototype.componentDidMount
    return class wrapComponent extends Component{
        componentDidMount(){
          console.log('------åŠ«æŒç”Ÿå‘½å‘¨æœŸ------')
          if (didMount) {
             didMount.apply(this) /* æ³¨æ„ `this` æŒ‡å‘é—®é¢˜ã€‚ */
          }
        }
        render(){
          return super.render()
        }
    }
  }
  
  @HOC
  class Index extends React.Component{
     componentDidMount(){
       console.log('â€”â€”â€”didMountedâ€”â€”â€”')
     }
     render(){
       return <div>hello,world</div>
     }
  }
  ```

* äº‹ä»¶ç›‘æ§

  ```jsx
  function ClickHoc (Component){
    return  function Wrap(props){
      const dom = useRef(null)
      useEffect(()=>{
       const handerClick = () => console.log('å‘ç”Ÿç‚¹å‡»äº‹ä»¶') 
       dom.current.addEventListener('click',handerClick)
       return () => dom.current.removeEventListener('click',handerClick)
      },[])
      return  <div ref={dom}  ><Component  {...props} /></div>
    }
  }
  
  @ClickHoc
  class Index extends React.Component{
     render(){
       return <div  className='index'  >
         <p>helloï¼Œworld</p>
         <button>ç»„ä»¶å†…éƒ¨ç‚¹å‡»</button>
      </div>
     }
  }
  export default ()=>{
    return <div className='box'  >
       <Index />
       <button>ç»„ä»¶å¤–éƒ¨ç‚¹å‡»</button>
    </div>
  }
  
  ```

  